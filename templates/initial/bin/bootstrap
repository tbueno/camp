#!/bin/bash
OS=$(uname)

# Check if the camp directory is provided as a parameter
CAMP_DIR="$1"
if [ -z $CAMP_DIR ]; then
    echo "Usage: $0 <camp_directory>"
    exit 1
fi


setup_nix() {

    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    if [ "$OS" = "Darwin" ]; then
        if command -v "brew" &> /dev/null; then
            echo "Homebrew is available. Skipping installation"
        else
            echo "Installing homebrew"
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        nix --extra-experimental-features nix-command --extra-experimental-features flakes flake update --flake "$CAMP_DIR/nix"
    elif [ "$OS" = "Linux" ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        nix-channel --add https://github.com/nix-community/home-manager/archive/release-24.11.tar.gz home-manager
        nix-channel --update
        nix-shell '<home-manager>' -A install
        ln -s $CAMP_DIR/nix/flake.nix ~/.config/home-manager/flake.nix -f
        ln -s $CAMP_DIR/nix/home.nix ~/.config/home-manager/home.nix -f
        home-manager switch
    fi
}

setup_nix
exec $SHELL

echo "You system was bootstrapped. Please open a new terminal and execute 'camp env rebuild' to complete your setup."
