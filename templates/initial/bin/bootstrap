#!/bin/bash
OS=$(uname)

# Check if the camp directory is provided as a parameter
CAMP_DIR="$1"
if [ -z $CAMP_DIR ]; then
    echo "Usage: $0 <camp_directory>"
    exit 1
fi

# Export USER if not already set (needed by home-manager)
export USER="${USER:-$(whoami)}"

setup_nix() {
    # Source Nix profile (try daemon mode first, then single-user mode)
    if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
        . "$HOME/.nix-profile/etc/profile.d/nix.sh"
    else
        echo "ERROR: Nix profile not found"
        exit 1
    fi
    if [ "$OS" = "Darwin" ]; then
        echo "Updating flake inputs..."
        nix --extra-experimental-features nix-command --extra-experimental-features flakes flake update --flake "$CAMP_DIR/nix"

        echo "Building and activating nix-darwin configuration..."
        USERNAME=$(whoami)
        USER_HOME="$HOME"
        # This DOES make system changes:
        # - Modifies /etc/bashrc and /etc/zshrc
        # - Modifies /etc/nix/nix.conf
        # - Installs packages defined in home-manager
        # - Activates the new system configuration

        sudo --preserve-env=HOME,USER nix --extra-experimental-features nix-command --extra-experimental-features flakes run nix-darwin -- switch --flake "$CAMP_DIR/nix#$USERNAME"
    elif [ "$OS" = "Linux" ]; then
        echo "Setting up home-manager with flakes..."

        # Create home-manager config directory if it doesn't exist
        mkdir -p ~/.config/home-manager

        # Create symlinks to our flake and home.nix
        ln -sf "$CAMP_DIR/nix/flake.nix" ~/.config/home-manager/flake.nix
        ln -sf "$CAMP_DIR/nix/home.nix" ~/.config/home-manager/home.nix

        # Build and activate the home-manager configuration using flakes
        echo "Building and activating home-manager configuration..."
        USERNAME=$(whoami)
        nix --extra-experimental-features 'nix-command flakes' run nixpkgs#home-manager -- switch --flake "$CAMP_DIR/nix#$USERNAME"
    fi
}

setup_nix
exec $SHELL

echo "You system was bootstrapped. Please open a new terminal and execute 'camp env rebuild' to complete your setup."
