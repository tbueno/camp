#!/bin/bash
OS=$(uname)

# Check if the camp directory is provided as a parameter
CAMP_DIR="$1"
if [ -z $CAMP_DIR ]; then
    echo "Usage: $0 <camp_directory>"
    exit 1
fi


install_nix() {
    if command -v "nix" &> /dev/null; then
        echo "Nix is available. Skipping installation"
    else
        if [ "$OS" = "Darwin" ]; then
            echo "This script is running on macOS"
        elif [ "$OS" = "Linux" ]; then
            echo "This script is running on Linux"
            sudo apt-get update
            sudo apt-get install -qq -y --no-install-recommends curl
        fi
        [ -f /etc/bashrc ] && sudo mv /etc/bashrc /etc/bashrc.before-nix
        [ -f /etc/zshrc ] && sudo mv /etc/zshrc /etc/zshrc.before-nix
        curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --determinate
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    fi
}
install_nix
nix --extra-experimental-features nix-command --extra-experimental-features flakes flake update --flake "$CAMP_DIR/nix"
